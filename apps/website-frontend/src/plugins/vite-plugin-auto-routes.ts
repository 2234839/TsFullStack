/** ABOUTME: Vite plugin for automatic route generation */
import type { Plugin } from 'vite'
import { readdirSync, existsSync, writeFileSync, mkdirSync } from 'fs'
import { join } from 'path'
import { fileURLToPath } from 'url'

interface VitePluginAutoRoutesOptions {
  /** æ˜¯å¦åœ¨å¼€å‘æ¨¡å¼ä¸‹ç›‘å¬æ–‡ä»¶å˜åŒ– */
  watch?: boolean
  /** è·¯ç”±æ–‡ä»¶ç”Ÿæˆè·¯å¾„ */
  outputPath?: string
  /** æ‰«æçš„æºç ç›®å½• */
  srcDir?: string
  /** é¡¹ç›®æ ¹ç›®å½• */
  projectsDir?: string
}

function findRouteFiles(dir: string, results: string[] = []): string[] {
  if (!existsSync(dir)) {
    return results
  }

  const files = readdirSync(dir, { withFileTypes: true })

  for (const file of files) {
    const fullPath = join(dir, file.name)

    if (file.isDirectory()) {
      findRouteFiles(fullPath, results)
    } else if (file.name.endsWith('.routeMap.ts')) {
      results.push(fullPath)
    }
  }

  return results
}

function generateRoutesContent(options: Required<VitePluginAutoRoutesOptions>): string {
  const { projectsDir } = options

  // æŸ¥æ‰¾é¡¹ç›®è·¯ç”±æ–‡ä»¶
  let projectRouteFiles: Array<{originalPath: string, projectName: string, varName: string}> = []
  const projectsFullPath = join(process.cwd(), projectsDir)

  if (existsSync(projectsFullPath)) {
    const projectDirs = readdirSync(projectsFullPath, { withFileTypes: true })

    for (const projectDir of projectDirs) {
      if (projectDir.isDirectory()) {
        // ä¼˜å…ˆæŸ¥æ‰¾é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„è·¯ç”±æ–‡ä»¶ï¼ˆç®€æ´ç»“æ„ï¼‰
        const projectRootPath = join(projectsFullPath, projectDir.name)
        let files = findRouteFiles(projectRootPath)

        // å¦‚æœé¡¹ç›®æ ¹ç›®å½•ä¸‹æ²¡æœ‰è·¯ç”±æ–‡ä»¶ï¼Œåˆ™æŸ¥æ‰¾ routes å­ç›®å½•ï¼ˆå…¼å®¹æ—§ç»“æ„ï¼‰
        if (files.length === 0) {
          const routesPath = join(projectRootPath, 'routes')
          if (existsSync(routesPath)) {
            files = findRouteFiles(routesPath)
          }
        }

        for (const file of files) {
          console.log(`ğŸ” Found route file: ${file}`)
          const varName = projectDir.name.replace(/[^a-zA-Z0-9]/g, '')
          projectRouteFiles.push({
            originalPath: file,
            projectName: projectDir.name,
            varName
          })
        }
      }
    }
  }

  // ç”Ÿæˆå¯¼å…¥ä»£ç 
  let content = `/** ABOUTME: Auto-generated frontend routes index */\n`
  content += `// Generated by vite-plugin-auto-routes\n`
  content += `// Generated at: ${new Date().toISOString()}\n`
  content += `// DO NOT EDIT !!! - This file is automatically generated\n\n`

  // ç”Ÿæˆé¡¹ç›®è·¯ç”±å¯¼å…¥
  if (projectRouteFiles.length > 0) {
    content += `// åŠ¨æ€å¯¼å…¥é¡¹ç›®è·¯ç”±\n`
    projectRouteFiles.forEach(routeFile => {
      // è®¡ç®—ç›¸å¯¹è·¯å¾„ï¼šä» src/routes/index.ts åˆ°é¡¹ç›®è·¯ç”±æ–‡ä»¶
      const relativePath = routeFile.originalPath.replace(process.cwd() + '/', '')
      content += `import * as ${routeFile.varName} from '../../${relativePath}';\n`
    })

    content += `\n/** æ‰€æœ‰å‰ç«¯é¡¹ç›®è·¯ç”±èšåˆ */\n`
    content += `export const routeModels = {\n`
    projectRouteFiles.forEach(routeFile => {
      content += `  ...${routeFile.varName}.default,\n`
    })
    content += `};\n\n`
  } else {
    content += `\n/** ç©ºè·¯ç”± */\n`
    content += `export const routeModels = {};\n\n`
  }

  // ç”Ÿæˆè·¯ç”±ç»Ÿè®¡ä¿¡æ¯
  content += `/** è·¯ç”±ç»Ÿè®¡ä¿¡æ¯ */\n`
  content += `export const routeStats = {\n`
  content += `  projectRoutes: ${projectRouteFiles.length},\n`
  content += `  generatedAt: '${new Date().toISOString()}'\n`
  content += `};\n\n`

  console.log(`ğŸ”„ Project routes updated: ${projectRouteFiles.length} total`)

  return content
}

export function vitePluginAutoRoutes(options: VitePluginAutoRoutesOptions = {}): Plugin {
  const resolvedOptions: Required<VitePluginAutoRoutesOptions> = {
    watch: true,
    outputPath: 'src/routes/index.ts',
    srcDir: 'src',
    projectsDir: 'projects',
    ...options
  }

  let isGenerating = false

  async function generateRoutes() {
    if (isGenerating) return
    isGenerating = true

    try {
      const content = generateRoutesContent(resolvedOptions)
      const outputPath = join(process.cwd(), resolvedOptions.outputPath)

      // ç¡®ä¿ç›®å½•å­˜åœ¨
      const dir = join(outputPath, '..')
      if (!existsSync(dir)) {
        mkdirSync(dir, { recursive: true })
      }

      writeFileSync(outputPath, content, 'utf8')
    } catch (error) {
      console.error('âŒ Failed to generate routes:', error)
    } finally {
      isGenerating = false
    }
  }

  return {
    name: 'vite-plugin-auto-routes',
    configureServer(server) {
      // åˆå§‹ç”Ÿæˆ
      generateRoutes()

      if (resolvedOptions.watch) {
        // ç›‘å¬æ–‡ä»¶å˜åŒ–
        const watcher = server.watcher

        // ç›‘å¬é¡¹ç›®è·¯ç”±æ–‡ä»¶
        const projectsPath = join(process.cwd(), resolvedOptions.projectsDir)
        if (existsSync(projectsPath)) {
          // ç›‘å¬æ–°çš„ç®€æ´ç»“æ„ï¼šé¡¹ç›®æ ¹ç›®å½•ä¸‹çš„è·¯ç”±æ–‡ä»¶
          watcher.add(join(projectsPath, '**/*.routeMap.ts'))
          // åŒæ—¶ä¿æŒå¯¹æ—§ç»“æ„çš„å…¼å®¹æ€§
          watcher.add(join(projectsPath, '**/routes/**/*.routeMap.ts'))
        }

        // æ–‡ä»¶å˜åŒ–æ—¶é‡æ–°ç”Ÿæˆ
        watcher.on('change', (filePath) => {
          if (filePath.endsWith('.routeMap.ts')) {
            console.log(`ğŸ“ Route file changed: ${filePath}`)
            generateRoutes()
          }
        })

        watcher.on('add', (filePath) => {
          if (filePath.endsWith('.routeMap.ts')) {
            console.log(`â• Route file added: ${filePath}`)
            generateRoutes()
          }
        })

        watcher.on('unlink', (filePath) => {
          if (filePath.endsWith('.routeMap.ts')) {
            console.log(`â– Route file removed: ${filePath}`)
            generateRoutes()
          }
        })
      }
    },
    buildStart() {
      // æ„å»ºå¼€å§‹æ—¶ç”Ÿæˆè·¯ç”±
      generateRoutes()
    }
  }
}