// This is a sample model to get you started.

/// Policy plugin for access control
plugin policy {
    provider = '@zenstackhq/plugin-policy'
}

/// TypeScript plugin for code generation
plugin typescript {
    provider = '@core/typescript'
    output = './.zenstack'
}

/// A sample data source using local sqlite db.
datasource db {
    provider = 'sqlite'
    url = env('DATABASE_URL')
}

/// Base types for mixin - 通用字段类型定义
type BaseTime {
    created DateTime @default(now())
    updated DateTime @updatedAt
}

type BaseId {
    id Int @id @default(autoincrement())
}

/// 全局权限控制 - 纯抽象层，仅包含权限策略
/// 继承此类型会自动获得：管理员拥有完全访问权限
type BaseGlobalAuth {
    @@allow('all', auth().role?[name == 'admin'])
}

/// 通用基础类型，包含时间和ID，继承全局权限
type Base with BaseTime, BaseId, BaseGlobalAuth {
}

/// 纯抽象层，包含全局权限，但没有ID字段，适合需要自定义id主键的模型
type NotIdBase with BaseTime, BaseGlobalAuth {
}

/// 角色
model Role with Base {
    name  String @unique
    users User[]

    @@allow("read",auth() != null)
}

/// User model
model User with NotIdBase {
    id           String         @id @default(cuid())
    // 注意：v3 中移除了 future()，id 是主键数据库层已禁止修改
    email        String         @unique @length(6, 32)
    // password 字段 - 在应用层处理哈希，不再使用 @password 属性（v3 已移除）
    password     String
    posts        Post[]
    role         Role[]

    userSession  UserSession[]
    /// 允许用户读取和更新自己的信息
    @@allow('read', auth() == this)
    /// 禁止未登录用户进行任何操作
    @@deny('all', auth() == null)

    file         File[]
    avatar       String?

    userData     UserData[]

    oAuthAccount OAuthAccount[]

    word         Word[]

    /** 代币记录 */
    tokens Token[]

    /** 任务记录 */
    tasks Task[]

    /** 代币消耗记录 */
    tokenTransactions TokenTransaction[]

    /** 资源记录 */
    resources Resource[]

    /** 套餐订阅记录 */
    tokenSubscriptions UserTokenSubscription[]
}

/// 资源类型枚举
enum ResourceType {
    IMAGE    // 图片
    TEXT     // 文本
    VIDEO    // 视频
    AUDIO    // 音频
    FILE     // 文件
}

/// 通用资源模型
model Resource with Base {
    /** 资源类型 */
    type ResourceType

    /** 资源标题 */
    title String

    /** 资源描述 */
    description String?

    /** 资源元数据（JSON存储，根据类型不同存储不同信息） */
    metadata Json

    /** 资源状态 */
    status String @default("pending")

    /** 关联的文件（如果有物理文件） */
    fileId Int?
    file File? @relation(fields: [fileId], references: [id])

    /** 关联任务 */
    task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
    taskId Int

    /** 关联用户 */
    user User @relation(fields: [userId], references: [id])
    userId String

    /** 标签 */
    tags String?

    /** 索引优化 */
    @@index([userId, type])
    @@index([taskId])
    @@index([status, created])

    /** 权限控制 */
    @@allow('read,create,update,delete', auth() == user)
    @@allow('read', auth() != null && status == "public")
}

/// UserSession 用于存储用户的登录会话信息。每个会话都有一个唯一的 token 和过期时间。
model UserSession with Base {
    token     String   @default(cuid())
    expiresAt DateTime
    userId    String
    user      User     @relation(fields: [userId], references: [id])

    /// 只允许用户读取和创建
    @@allow('read,create', auth() == user)
    // 禁止过期session 被用户读取，但管理员除外
    @@deny('all',(expiresAt < now()) &&  (auth().role?[name == 'admin']==false))
}

enum OauthProvider {
    GITHUB
}
/// 第三方账号关联
model OAuthAccount with Base {
    userId     String        // 关联的用户ID
    user       User          @relation(fields: [userId], references: [id], onDelete: Cascade)

    provider   OauthProvider // 第三方提供商名称，
    providerId String        // 第三方提供商的唯一标识符
    // 用户资料数据
    profile    Json?         // 存储原始的用户资料数据

    // 权限控制，绝对不应该让用户可以直接修改这里的数据，否则就能顶替别人的账号了
    @@allow('read', auth() == user)
}

// 存储策略枚举
enum StorageType {
    LOCAL
    S3
}

enum FileStatusEnum {
    public
    private
    protected
    deleted
}
model File with Base {
    filename    String      // 原始文件名
    mimetype    String      // 文件类型
    size        Int         // 文件大小（字节）
    path        String      // 存储路径或URL
    storageType StorageType // 存储类型
    metadata    Json?       // 额外的元数据
    status      FileStatusEnum @default(private)// 文件状态
    author      User           @relation(fields: [authorId], references: [id])
    authorId    String

    /** 资源记录 */
    resources Resource[]

    @@allow('read,create,delete', auth() == author)
}


enum LogLevel {
    DEBUG
    INFO
    WARN
    ERROR
}
model SystemLog with BaseId,BaseGlobalAuth {
    level      LogLevel
    message    String?
    logs       Json?
    authUserId String?
    created    DateTime @default(now())
}
/// 用户数据存储模型 - 用于存储用户的应用JSON数据
model UserData with Base {
    // 数据标识符，可用于区分不同类型或用途的数据
    key         String
    // 实际存储的JSON数据
    data        Json
    // 数据描述（可选）
    description String?
    // 版本号，用于处理数据更新冲突
    version     Int     @default(1)
    // 关联的用户
    user        User    @relation(fields: [userId], references: [id])
    userId      String
    // 标签，用于分类和搜索
    tags        String?
    // 应用标识符，用于区分不同应用的数据
    appId       String?

    // 用户和key的组合唯一索引，确保每个用户的每个key只有一条记录
    @@unique([userId, key, appId])

    // 权限控制：用户只能读取和操作自己的数据
    @@allow('read,create,update,delete', auth() == user)
}

/// 任务队列处理
model Queue with Base {
    name        String    // 队列名称，可用于区分不同类型的任务
    payload     Json    // 任务数据，JSON 格式
    status      String    // PENDING, PROCESSING, COMPLETED, FAILED
    priority    Int       @default(0) // 优先级，数字越大优先级越高
    attempts    Int       @default(0) // 尝试次数
    maxAttempts Int       @default(3) // 最大尝试次数
    workerId    String?   // 处理该任务的消费者ID
    result      Json?   // 处理结果，JSON 格式
    error       String?   // 错误信息
    startedAt   DateTime? // 开始处理时间
    completedAt DateTime? // 完成时间
    runAt       DateTime  @default(now()) // 计划执行时间，支持延迟任务

    @@index([status, runAt, priority]) // 索引优化查询性能
    @@index([name, status]) // 按队列名称和状态查询
    @@index([workerId, status]) // 按工作者和状态查询
}


// ===== 下面是业务模型，与系统基础无关，可自行选择需要的模块删改 =====

/// Post model
model Post  with Base {
    title     String  @length(1, 256)
    content   String
    published Boolean @default(false)
    author    User    @relation(fields: [authorId], references: [id])
    authorId  String

    // allow read for all signin users
    @@allow('read',auth() != null && published)
    // full access by author
    @@allow('all', author == auth())
}

/// AI 英语学习数据模型
model Word with Base {
    /// word 的小写形式，作为唯一标识符
    key           String
    /// 单词原文
    word          String
    /// 记忆等级
    memoryLevel   Int      @default(0)
    /// 点击次数
    clickCount    Int      @default(0)
    /// 最后点击时间戳
    lastClickTime DateTime @default(now())
    /// 翻译列表（存储为JSON数组）
    translations  Json
    /// AI翻译（可选）
    aiTranslation String?
    /// 难度系数（可选）
    difficulty    Float?
    /// 例句列表（存储为JSON数组，可选）
    examples      Json?
    /// 语法信息（可选）
    grammar       String?
    /// 发音信息（可选）
    pronunciation String?

    /// 关联的用户
    author        User     @relation(fields: [authorId], references: [id])
    authorId      String
    /// 确保每个用户的单词key唯一
    @@unique([key, authorId])
    /// 权限控制：用户只能读取和操作自己的单词数据
    @@allow('read,create,update,delete', auth() == author)
}

/// AI 模型配置
model AiModel with Base {
    /// 模型名称
    name        String
    /// 模型标识符
    model       String
    /// 模型类型
    modelType   AiModelType @default(TEXT)
    /// API基础URL
    baseUrl     String
    /// API密钥
    apiKey      String
    // 注意：不再使用 @omit 属性（v3 已移除），需要在查询时手动排除
    /// 最大Token数
    maxTokens   Int     @default(2000)
    /// 温度参数
    temperature Float   @default(0.7)
    /// 是否启用
    enabled     Boolean @default(true)
    /// 权重（用于负载均衡）
    weight      Int     @default(100)
    /// 每分钟请求限制
    rpmLimit    Int     @default(60)
    /// 每小时请求限制
    rphLimit    Int     @default(1000)
    /// 每日请求限制
    rpdLimit    Int     @default(10000)
    /// 描述信息
    description String?
    /// 模型配置（JSON存储，用于存储不同类型模型的特定配置）
    config      Json?

    @@allow('read', auth() != null)
}

/// AI 模型类型枚举
enum AiModelType {
    TEXT       // 文本生成模型（GPT、Claude等）
    IMAGE      // 图片生成模型（DALL-E、Stability、通义千问等）
    VIDEO      // 视频生成模型（未来）
    AUDIO      // 音频生成模型（未来）
    TRANSLATION // 翻译模型（未来）
}

/// ai API调用日志记录
model AiCallLog with Base {
    /// 客户端IP地址
    clientIp     String
    /// 用户ID（可选，未登录用户为null）
    userId       String?
    /// AI模型ID
    aiModelId    Int
    /// 模型标识符（如 gpt-3.5-turbo, claude-3-sonnet 等）
    modelName    String
    /// 输入的token数量
    inputTokens  Int?
    /// 输出的token数量
    outputTokens Int?
    /// 调用是否成功
    success      Boolean  @default(true)
    /// 调用时间戳
    timestamp    DateTime @default(now())

    @@index([clientIp, timestamp])
    @@index([userId, timestamp])
    @@index([aiModelId, timestamp])
    @@index([modelName, timestamp])
    @@index([userId, modelName])

    /// 权限控制：
    /// - 管理员可以完全访问（所有权限）
    /// - 普通用户可以查看自己的数据（只读）
    /// - 未登录用户不能访问
    @@allow('read',auth() != null && userId == auth().id)
}

/// ==================== 代币系统 ====================

/// 代币类型枚举
enum TokenType {
    MONTHLY    // 月度代币（每月重置）
    YEARLY     // 年度代币（每年重置）
    PERMANENT  // 永久代币（永不过期）
}

/// 代币套餐
model TokenPackage with Base {
    /** 套餐名称 */
    name String

    /** 套餐描述 */
    description String?

    /** 代币类型 */
    type TokenType

    /** 代币数量 */
    amount Int

    /** 价格（分） */
    price Int?

    /** 套餐时长（月数，0表示永久） */
    durationMonths Int @default(0)

    /** 是否启用 */
    active Boolean @default(true)

    /** 排序顺序 */
    sortOrder Int @default(0)

    /** 用户订阅记录 */
    userSubscriptions UserTokenSubscription[]

    /** 索引 */
    @@index([active, sortOrder])

    /** 权限控制 */
    @@allow('read', auth() != null)
}

/// 用户代币套餐订阅
model UserTokenSubscription with Base {
    /** 关联用户 */
    user User @relation(fields: [userId], references: [id])
    userId String

    /** 关联套餐 */
    package TokenPackage @relation(fields: [packageId], references: [id])
    packageId Int

    /** 订阅开始时间 */
    startDate DateTime @default(now())

    /** 订阅结束时间（null表示永久） */
    endDate DateTime?

    /** 下次发放时间（月度套餐每月月初发放） */
    nextGrantDate DateTime

    /** 是否激活 */
    active Boolean @default(true)

    /** 发放次数（用于记录已发放了几个月） */
    grantsCount Int @default(0)

    /** 索引 */
    @@index([userId, active])
    @@index([nextGrantDate])

    /** 权限控制 */
    @@allow('read', auth() == user)
}

/// 代币记录
model Token with Base {
    /** 代币类型 */
    type TokenType

    /** 代币数量 */
    amount Int

    /** 已使用数量 */
    used Int @default(0)

    /** 过期时间 */
    expiresAt DateTime?

    /** 关联用户 */
    user User @relation(fields: [userId], references: [id])
    userId String

    /** 代币来源（系统赠送、购买、活动奖励等） */
    source String @default("system")

    /** 来源ID（如订单ID、活动ID等） */
    sourceId String?

    /** 描述信息 */
    description String?

    /** 是否已激活（延迟发放的代币） */
    active Boolean @default(true)

    /** 索引优化 */
    @@index([userId, type, expiresAt])
    @@index([userId, active])
    @@index([expiresAt])

    /** 权限控制 */
    @@allow('read', auth() == user)
}

/// 代币消耗记录
model TokenTransaction with Base {
    /** 消耗的代币数量 */
    amount Int

    /** 消耗时的代币类型 */
    tokenType TokenType

    /** 关联用户 */
    user User @relation(fields: [userId], references: [id])
    userId String

    /** 关联任务 */
    task Task @relation(fields: [taskId], references: [id])
    taskId Int

    /** 余额快照（消耗后的剩余代币） */
    balanceSnapshot Json

    /** 备注 */
    note String?

    /** 索引优化 */
    @@index([userId, taskId])
    @@index([userId, created])
    @@index([taskId])

    /** 权限控制 */
    @@allow('read', auth() == user)
}

/// ==================== 任务系统 ====================

/// 任务类型枚举
enum TaskType {
    AI_IMAGE_GENERATION    // AI 图片生成
    AI_TEXT_GENERATION     // AI 文本生成
    AI_TRANSLATION         // AI 翻译
    AI_VIDEO_GENERATION    // AI 视频生成（未来）
    CUSTOM                 // 自定义任务
}

/// 任务状态枚举
enum TaskStatus {
    PENDING       // 等待处理
    PROCESSING    // 处理中
    COMPLETED     // 已完成
    FAILED        // 失败
    CANCELLED     // 已取消
}

/// 通用任务模型
model Task with Base {
    /** 任务类型 */
    type TaskType

    /** 任务状态 */
    status TaskStatus @default(PENDING)

    /** 任务标题 */
    title String

    /** 任务描述 */
    description String?

    /** 任务参数（JSON 存储，如提示词、尺寸等） */
    inputParams Json

    /** 任务结果（JSON 存储，如生成的图片URL、文本等） */
    outputResult Json?

    /** 消耗的代币数量 */
    tokenCost Int

    /** 错误信息 */
    error String?

    /** 开始时间 */
    startedAt DateTime?

    /** 完成时间 */
    completedAt DateTime?

    /** 关联用户 */
    user User @relation(fields: [userId], references: [id])
    userId String

    /** 代币消耗记录 */
    transactions TokenTransaction[]

    /** 外部任务ID（用于查询第三方服务进度） */
    externalTaskId String?

    /** 标签（用于分类和搜索） */
    tags String?

    /** 资源记录 */
    resources Resource[]

    /** 索引优化 */
    @@index([userId, status])
    @@index([userId, type])
    @@index([status, created])
    @@index([type, created])

    /** 权限控制 */
    @@allow('read,create,update,delete', auth() == user)
}

